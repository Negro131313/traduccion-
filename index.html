import tkinter as tk
import pyperclip
import re
import time
import threading
import pyautogui
from tkinter import scrolledtext

# Variables globales
ultimo_enlace = ""
lista_enlaces = []
procesamiento_activo = False
detener_proceso = False

def es_enlace_valido(texto):
    patron = r'^https?://[^\s/$.?#].[^\s]*$'
    return re.match(patron, texto) is not None

def verificar_portapapeles():
    global ultimo_enlace, lista_enlaces, procesamiento_activo
    
    try:
        texto_copiado = pyperclip.paste()
        
        if es_enlace_valido(texto_copiado) and texto_copiado not in lista_enlaces:
            ultimo_enlace = texto_copiado
            lista_enlaces.append(texto_copiado)
            actualizar_interfaz()
            
            # Iniciar procesamiento si hay 5 enlaces
            if len(lista_enlaces) >= 5 and not procesamiento_activo:
                procesamiento_activo = True
                threading.Thread(target=procesar_enlaces, daemon=True).start()
                
    except pyperclip.PyperclipException:
        pass
    
    ventana.after(500, verificar_portapapeles)

def actualizar_interfaz():
    area_texto.delete(1.0, tk.END)
    for i, enlace in enumerate(lista_enlaces, 1):
        area_texto.insert(tk.END, f"Enlace {i}: {enlace}\n")
    
    area_texto.insert(tk.END, "\nEstado: ")
    if detener_proceso:
        area_texto.insert(tk.END, "DETENIDO (presione 'ñ' para reanudar)", "rojo")
    elif procesamiento_activo:
        area_texto.insert(tk.END, "PROCESANDO...", "verde")
    else:
        area_texto.insert(tk.END, "ESPERANDO ENLACES...")
    
    area_texto.see(tk.END)

def procesar_enlaces():
    global lista_enlaces, procesamiento_activo, detener_proceso
    
    time.sleep(2)
    
    for enlace in lista_enlaces[:]:  # Procesar los enlaces
        if detener_proceso:
            break
        
        try:
            pyautogui.hotkey('ctrl', 't')
            time.sleep(1)
            pyautogui.write('https://ssstik.io/es')
            pyautogui.press('enter')
            time.sleep(3)
            
            pyperclip.copy(enlace)
            pyautogui.hotkey("ctrl", "v")
            time.sleep(1)
            pyautogui.press('enter')
            time.sleep(2)
            
            pyautogui.click(1300, 732)  # Botón Descargar
            time.sleep(2)
            pyautogui.click(891, 764)   # Botón descarga final
            time.sleep(3)
            
            pyautogui.hotkey('ctrl', 'w')
            time.sleep(2)
            
        except Exception as e:
            area_texto.insert(tk.END, f"\nERROR: {str(e)}\n", "error")
            area_texto.see(tk.END)
        
        ventana.after(0, actualizar_interfaz)
    
    lista_enlaces.clear()
    procesamiento_activo = False
    detener_proceso = False
    ventana.after(0, actualizar_interfaz)

def manejar_tecla(event):
    global detener_proceso
    if event.char == 'ñ' or event.keysym == 'ntilde':
        detener_proceso = not detener_proceso
        actualizar_interfaz()

def limpiar_portapapeles():
    try:
        pyperclip.copy("")  # Vacía el portapapeles
    except pyperclip.PyperclipException:
        pass

# --- Crear ventana principal ---
ventana = tk.Tk()
ventana.title("Auto Descargador de Enlaces")
ventana.geometry("600x400")

ventana.configure(bg="#f0f0f0")
ventana.option_add("*Font", "Arial 10")

area_texto = scrolledtext.ScrolledText(
    ventana, wrap=tk.WORD, bg="white", padx=10, pady=10
)
area_texto.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

area_texto.tag_config("verde", foreground="green")
area_texto.tag_config("rojo", foreground="red")
area_texto.tag_config("error", foreground="darkred", background="#ffe6e6")

instrucciones = "Copie enlaces válidos (se acumularán).\n"
instrucciones += "Cuando haya 5 enlaces, se procesarán automáticamente.\n"
instrucciones += "Presione 'ñ' para detener/reanudar el proceso."

tk.Label(
    ventana, text=instrucciones, bg="#f0f0f0",
    justify=tk.LEFT, padx=10
).pack(pady=(0, 5))

ventana.bind('<Key>', manejar_tecla)

# Limpiar portapapeles al cerrar ventana
ventana.protocol("WM_DELETE_WINDOW", lambda: (limpiar_portapapeles(), ventana.destroy()))

verificar_portapapeles()
actualizar_interfaz()
ventana.mainloop()
